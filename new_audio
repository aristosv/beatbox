update_media ()
{
 remotemedia="/media/audio"
 ftpuser="signage@bbxmd.com"
 ftphost="signage-ftp.bbxmd.com"
 localmedia="/home/pi/media/audio"
 ftppass=""
 ftpsettings="set ftp:ssl-allow no ; set net:reconnect-interval-base 5 ; set net:max-retries 2"
 lftp ftp://$ftpuser:$ftppass@$ftphost -e "$ftpsettings ; mirror -v -e $remotemedia $localmedia ; quit"
}

stop_service ()
{
 sudo systemctl is-active --quiet audio.service && sudo systemctl stop audio.service && sudo rm /etc/systemd/system/audio.service && echo stopped audio
 sudo systemctl is-active --quiet video.service && sudo systemctl stop video.service && sudo rm /etc/systemd/system/video.service && echo stopped video
 sudo systemctl is-active --quiet images.service && sudo systemctl stop images.service && sudo rm /etc/systemd/system/images.service && echo stopped images
 sudo systemctl is-active --quiet stream.service && sudo systemctl stop stream.service && sudo rm /etc/systemd/system/stream.service && echo stopped stream
 sudo systemctl is-active --quiet youtube.service && sudo systemctl stop youtube.service && sudo rm /etc/systemd/system/youtube.service && echo stopped youtube
 sudo systemctl is-active --quiet browser.service && sudo systemctl stop browser.service && sudo rm /etc/systemd/system/browser.service && echo stopped browser
}

start_service ()
{
 echo '[Unit]' | sudo tee -a /etc/systemd/system/audio.service > /dev/null
 echo 'Description=digital signage audio' | sudo tee -a /etc/systemd/system/audio.service > /dev/null
 echo 'After=network.target' | sudo tee -a /etc/systemd/system/audio.service > /dev/null
 echo '[Service]' | sudo tee -a /etc/systemd/system/audio.service > /dev/null
 echo 'ExecStart=/bin/bash -c "while true ; do for audio in $(ls /home/pi/media/audio/* | shuf); do omxplayer --no-keys --no-osd $audio; done; done"' | sudo tee -a /etc/systemd/system/audio.service > /dev/null
 echo 'Restart=always' | sudo tee -a /etc/systemd/system/audio.service > /dev/null
 echo '[Install]' | sudo tee -a /etc/systemd/system/audio.service > /dev/null
 echo 'WantedBy=multi-user.target' | sudo tee -a /etc/systemd/system/audio.service > /dev/null
 sudo systemctl daemon-reload
 sudo systemctl start audio.service
}

update_media ; stop_service ; start_service
