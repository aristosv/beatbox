monitoring_services ()
{
cat > /etc/systemd/system/cpumonitor.service << 'EOL'
[Unit]
Description=cpu monitor
After=network.target

[Service]
Environment=cpu_usage=$(top -b -n1 | grep Cpu | awk '{print $2 + $4}' | awk '{print int($1+0.5)}')
Environment=send_email='echo Subject: CPU Alert - $HOSTNAME; echo CPU Usage on $HOSTNAME is $cpu_usage%;'
ExecStart=/bin/bash -c "while true; do if [ $cpu_usage -gt $cpu_threshold ]; then { $send_email } | ssmtp $email_address; fi; sleep $check_interval; done"
Restart=always

[Install]
WantedBy=multi-user.target
EOL

cat > /etc/systemd/system/diskmonitor.service << 'EOL'
[Unit]
Description=disk monitor
After=network.target

[Service]
Environment=disk_usage=$(df --output=pcent / | sed '1d;s/^ //;s/%//')
Environment=send_email='echo Subject: Disk Alert - $HOSTNAME; echo Disk Usage on $HOSTNAME is $disk_usage%;'
ExecStart=/bin/bash -c "while true; do if [ $disk_usage -gt $disk_threshold ]; then { $send_email } | ssmtp $email_address; fi; sleep $check_interval; done"
Restart=always

[Install]
WantedBy=multi-user.target
EOL

cat > /etc/systemd/system/memorymonitor.service << 'EOL'
[Unit]
Description=memory monitor
After=network.target

[Service]
Environment=memory_usage=$(free | grep Mem | awk '{print $3/$2 * 100.0}' | awk '{print int($1+0.5)}')
Environment=send_email='echo Subject: Memory Alert - $HOSTNAME; echo Memory Usage on $HOSTNAME is $memory_usage%;'
ExecStart=/bin/bash -c "while true; do if [ $memory_usage -gt $memory_threshold ]; then { $send_email } | ssmtp $email_address; fi; sleep $check_interval; done"
Restart=always

[Install]
WantedBy=multi-user.target
EOL

cat > /etc/systemd/system/temperaturemonitor.service << 'EOL'
[Unit]
Description=temperature monitor
After=network.target

[Service]
Environment=temperature_level=$(sudo /opt/vc/bin/vcgencmd measure_temp | sed -e 's/temp=//' | sed -e "s/[.].*//")
Environment=send_email='echo Subject: Temperature Alert - $HOSTNAME; echo Temperature on $HOSTNAME is $temperature_level;'
ExecStart=/bin/bash -c "while true; do if [ $temperature_level -gt $temperature_threshold ]; then { $send_email } | ssmtp $email_address; fi; sleep $check_interval; done"
Restart=always

[Install]
WantedBy=multi-user.target
EOL

sudo systemctl enable cpumonitor.service > /dev/null 2>&1
sudo systemctl enable diskmonitor.service > /dev/null 2>&1
sudo systemctl enable memorymonitor.service > /dev/null 2>&1
sudo systemctl enable temperaturemonitor.service > /dev/null 2>&1
}

echo enable monitoring services ; monitoring_services













cat > /etc/systemd/system/cpumonitor.service << 'EOL'
[Unit]
Description=cpu monitor
After=network.target

[Service]
ExecStart=/bin/bash -c "while true; do if [ $(top -b -n1 | grep Cpu | awk '{print $2 + $4}' | awk '{print int($1+0.5)}') -gt 90 ]; then { echo Subject: CPU Alert - $HOSTNAME; echo CPU Usage on $HOSTNAME is $(top -b -n1 | grep Cpu | awk '{print $2 + $4}' | awk '{print int($1+0.5)}')%; } | ssmtp $emailaddress; fi; sleep 3600; done" | sudo tee -a /etc/systemd/system/cpumonitor.service
Restart=always

[Install]
WantedBy=multi-user.target
EOL




create_cpu_monitor_script ()
{
sudo cat > /usr/local/bin/cpu_monitor << 'EOL'
emailaddress=
cpu_threshold=90
check_interval=300

while :
do
 cpu_usage=$(top -b -n1 | grep Cpu | awk '{print $2 + $4}' | awk '{print int($1+0.5)}')
  if [ $cpu_usage -gt $cpu_threshold ]
   then
   echo CPU Usage on $HOSTNAME is $cpu_usage%
   { echo Subject: CPU Alert - $cpu_usage% on $HOSTNAME; echo CPU Usage on $HOSTNAME is $cpu_usage%; } | ssmtp $emailaddress
  fi
 sleep $check_interval
done
EOL

sudo chmod a+rx /usr/local/bin/cpu_monitor
}

create_cpu_monitor_service ()
{
sudo cat > /etc/systemd/system/cpumonitor.service << 'EOL'
[Unit]
Description=cpu monitor
After=network.target

[Service]
ExecStart=/usr/local/bin/cpu_monitor
Restart=always

[Install]
WantedBy=multi-user.target
EOL

sudo systemctl daemon-reload
sudo systemctl start cpumonitor.service
sudo systemctl enable cpumonitor.service > /dev/null 2>&1
}

create_cpu_monitor_script
create_cpu_monitor_service
